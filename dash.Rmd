---
title: "COVID-19"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny_prerendered
---

```{r todods,include=F}
# TODO: Add view of proportion of tests that are positive to the US view
# TODO: add deselect all to us testing page
# TODO: Animate the bar charts next to the maps
```

```{r setup,context="setup",include=FALSE}
library(flexdashboard)
library(shiny)
library(shinyWidgets)

# Tidyverse
library(readr)
library(dplyr)
library(magrittr)
library(lubridate)
library(tidyr)
library(purrr)
library(stringr)

# Visualizations 
library(leaflet)
library(highcharter)
library(htmltools)
library(sf)
library(USAboundariesData)

# Other
library(jsonlite)
library(zoo)
```


```{r setupdata,context="server-start",include=F}
dataset <- reactiveValues()
datasetdt <- reactiveValues()
updateFreq = 10 * 60 * 1000

update_dataset_dt_file <- function(tag, file) {
  datasetdt[[tag]] <- file.mtime(file)
}

update_dataset_dt_url <- function(tag, url) {
  resp <- httr::HEAD(url)
  datasetdt[[tag]] <- dmy_hms(resp$headers$date)
}

get_url_date <- function(url) {
  resp <- httr::HEAD(url)
  dmy_hms(resp$headers$date)
}

get_new_data <- function(tag, url, f) {
  out <- read_csv(url) %>% 
    f()
  update_dataset_dt_url(tag, url)
  out 
}

makePoll <- function(tag, url, f) reactivePoll(
  intervalMillis = updateFreq, session = NULL, 
  checkFunc = function() get_url_date(url), 
  valueFunc = function() get_new_data(tag, url, f)
)

get_new_data_json <- function(tag, url, f) {
  out <- fromJSON(url) %>% 
    f()
  update_dataset_dt_url(tag, url)
  out 
}
```


```{r setup_geometry,include=F,context="server-start",cache=T}
counties <- USAboundaries::us_counties()
states <- USAboundaries::us_states()

load("badzips.Rda")
zips <- USAboundaries::us_zipcodes() %>%
  filter(str_starts(zipcode, "10") | str_starts(zipcode, "11"),
         ! zipcode %in% badzips)

load("./census_data.Rda")

census_data %<>%
  select(geoid=GEOID, estimate, names) %>% 
  spread(key="names", value="estimate") %>%
  mutate(pop = male + female)

geometries <- counties %>%
  select(county=name, geoid, state=state_name, geometry, aland, awater) %>%
  rbind(
    states %>% select(geoid, state=state_name, geometry, aland, awater) %>%
      mutate(county=NA)
  ) %>%
  left_join(census_data) %>% 
  rbind(
    counties %>% 
      filter(
        state_name == "New York", 
        name %in% c("Kings", "Queens", "New York", "Bronx", "Staten Island", "Richmond")
      ) %>% 
      left_join(census_data) %>% 
      summarize(
        geometry = st_combine(geometry), 
        aland = sum(aland), 
        awater = sum(awater), 
        male = sum(male), 
        female = sum(female), 
        housing_units = sum(housing_units), 
        pop = sum(pop)
      ) %>%
      mutate(
        state = "New York", 
        county = "New York City",
        geoid = NA
      )
  ) %>% 
  mutate(
    centroid = sf::st_centroid(geometry), 
    lat = map(centroid, ~.x[[2]][1]), 
    lng = map(centroid, ~.x[[1]][1]), 
    lat = unlist(lat), 
    lng = unlist(lng),
    point = map2(lng, lat, ~st_point(c(.x, .y), dim="XY")),
    bbox = map(geometry, ~st_bbox(.))
  ) %>% select(-centroid) 

rm(counties)
rm(states)

continental_us <- geometries %>%
  filter(! state %in% c("Alaska", "Hawaii")) %>% 
  ungroup() %>% 
  summarize(us = st_combine(geometry)) 
```

```{r data_jh_and_locations,context="server-start",include=F}
url_world_confirmed <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"
url_world_dead <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv"
url_world_recovered <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv"

confirmed <- read_csv("./COVID-19/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")

locations <- confirmed[, 1:4] %>%
  set_colnames(c("Sublocation", "Location", "lat", "lng")) %>%
  mutate(us_level="Country", Subsublocation=NA) %>% 
  bind_rows(
    geometries %>% 
      rename(Sublocation=state, Subsublocation=county) %>%
      mutate(
        Location="US",
        us_level = if_else(is.na(Subsublocation), "State", "County")
      ) %>% select(Location, Sublocation, Subsublocation, us_level, lat, lng)
  ) %>%
  mutate(loc_id = 1:n()) %>%
  select(Location, Sublocation, Subsublocation, lat, lng, us_level, loc_id)

geometries %<>%
  left_join(locations %>% 
              select(state = Sublocation, 
                     county = Subsublocation, 
                     loc_id)
  )

process_jh_confirmed <- function(x) x %>% 
  inner_join(
    locations %>% 
      select(`Province/State`=Sublocation, `Country/Region`=Location, loc_id)
  ) %>%
  select(loc_id, matches("[0-9]+.[0-9]+.[0-9]+")) %>% 
  gather(key="date", value="confirmed", -loc_id)

process_jh_dead <- function(x) x %>% 
  inner_join(
    locations %>% 
      select(`Province/State`=Sublocation, `Country/Region`=Location, loc_id)
  ) %>%
  select(loc_id, matches("[0-9]+.[0-9]+.[0-9]+")) %>% 
  gather(key="date", value="dead", -loc_id)

process_jh_recovered <- function(x) x %>% 
  inner_join(
    locations %>% 
      select(`Province/State`=Sublocation, `Country/Region`=Location, loc_id)
  ) %>%
  select(loc_id, matches("[0-9]+.[0-9]+.[0-9]+")) %>% 
  gather(key="date", value="recovered", -loc_id)

dataset$confirmed <- makePoll("Confirmed Cases (JH)", url_world_confirmed, 
                              process_jh_confirmed) 

dataset$dead <- makePoll("Confirmed Dead (JH)", url_world_dead, 
                         process_jh_dead)

dataset$recoveries <- makePoll("Confirmed Recovered (JH)", url_world_recovered, 
                               process_jh_recovered)



world_cases_jh <- reactive({
  full_join(dataset$confirmed(), dataset$dead()) %>%
    full_join(dataset$recoveries()) %>%
    group_by(loc_id) %>% 
    mutate(
      date = mdy(date)
    ) %>%
    arrange(date) %>%
    mutate(
      new_dead = dead - lag(dead, 1, default=0),
      new_confirmed = confirmed - lag(confirmed, 1, default=0)
    )
})
```

```{r data_nytimes,context="server-start",include=F}
# ------ NY TIMES
url_ny_county <- "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"
url_ny_state <- "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv"

process_ny_county <- function(x) {
  x %>% 
    left_join(
      locations %>% 
        select(county = Subsublocation, state=Sublocation, loc_id)
    ) %>%
    select(-county, -state)
}

process_ny_state <- function(x) {
  x %>% 
    filter(! state %in% c(78, 66)) %>% # Exclude virgin islands and guam
    left_join(locations %>% 
                filter(is.na(Subsublocation)) %>% 
                select(state=Sublocation, loc_id)) %>% 
    select(-state)
}

dataset$cases_county_nyt <- makePoll("NYT Counties", 
                                     url_ny_county, 
                                     process_ny_county)

dataset$cases_state_nyt <- makePoll("NYT States", 
                                    url_ny_state, 
                                    process_ny_state) 
```


```{r data_covid_track,context="server-start",include=F}
# ------------ COVID Tracking Project
url_covid_track <- "https://covidtracking.com/api/v1/states/daily.json"

process_covid_track <- function(x) x %>%
  mutate(
    date = ymd(date)
  ) %>% inner_join(
    data.frame(state = state.abb, state_full=state.name)
  ) %>% 
  select(-state) %>% 
  rename(state=state_full) %>%
  left_join(
    locations %>% filter(is.na(Subsublocation)) %>% select(state=Sublocation, loc_id)
  ) %>%
  group_by(date, loc_id) %>%
  summarize_if(is.integer, ~max(if_else(is.na(.), 0L, .))) %>%
  ungroup()

dataset$covid_track <- reactivePoll(
  intervalMillis = updateFreq, session=NULL,
  checkFunc = function() get_url_date(url_covid_track),
  valueFunc = function() get_new_data_json(tag="COVID Track", 
                                           url=url_covid_track, 
                                           f=process_covid_track)
)
```


```{r data_interventions,context="server-start",include=F}
# ---------------  Intervention data
url_interventions <- "https://raw.githubusercontent.com/Keystone-Strategy/covid19-intervention-data/master/npi_data_03-24-2020.csv"

process_interventions <- function(x) x %>%
  select(-matches("X[0-9]+")) %>%
  mutate(
    state.abb = str_match(Intervention, "., ([A-Z]+)")[, 2], 
    county = str_match(Intervention, "(.+)\\sCounty.")[,2],
    county = case_when(
      ! is.na(county) ~ county, 
      str_detect(Intervention, "DC") ~ "Washington", 
      str_detect(Intervention, "New York City") ~ "New York City", 
      TRUE ~ county
    ), 
    state.abb = if_else(is.na(state.abb), "DC", state.abb)
  ) %>% 
  select(-Intervention) %>% 
  gather(key="intervention", value="date", -state.abb, -county) %>% 
  filter(! is.na(date)) %>%
  inner_join(data.frame(state.abb=state.abb, state.name=state.name)) %>% 
  mutate(
    date = mdy(date)
  ) %>% 
  inner_join(locations %>% select(county=Subsublocation, state.name=Sublocation, loc_id)) %>% 
  select(-matches("state"), -county)


dataset$interventions <- makePoll("Interventions", url_interventions,
                                  process_interventions)
```

```{r data_nyhealth,context="server-start",include=F}
url_nyzipcode <- "https://raw.githubusercontent.com/nychealth/coronavirus-data/master/tests-by-zcta.csv"

process_nyzipcode <- function(x) x %>% 
  filter(! is.na(MODZCTA)) %>% 
  rename(zipcode=MODZCTA)

dataset$nyzipcode <- makePoll("NY Testing by Zipcode", 
                              url_nyzipcode, 
                              process_nyzipcode)
```

```{r pull_census,context="data",include=F,eval=F}
library(tidycensus)

census_to_pull <- data.frame(
  variable = c("B00001_001", # Pop
               "B00002_001", # Housing units, 
               "B01001_002", # Male
               "B01001_026"  # Female
  ),
  names = c("pop", "housing_units", "male", "female")
)

census_data <- get_acs(geography = "county", year = 2015, 
                       variables=as.character(census_to_pull$variable)
) %>% 
  bind_rows(
    get_acs(geography = "state", year = 2015, 
            variables=as.character(census_to_pull$variable)
    )
  ) %>%
  inner_join(census_to_pull)

save(census_data, file="census_data.Rda")
```



World Overview
=======================================================================


Inputs {.sidebar}
-----------------------------------------------------------------------

### Input

```{r context="server",include=F}
output$worldoverviewinputs <- renderUI({
  cases <- world_cases_jh()
  
  tagList(
    sliderInput(
      "worlddate",
      "Date",
      min =  min(cases$date),
      max = max(cases$date),
      value = max(cases$date),
      timeFormat = "%Y-%m-%d",
      animate = T
    ),
    radioButtons(
      "worldscale",
      "Scale",
      choices = list(Linear = "linear",
                     Logarithmic = "logarithmic")
    ),
    sliderTextInput(
      "worldmincases", 
      "Minimum Number of Cases", 
      choices = 10^(0:4),
      selected = 1
    )
  )
})
```
```{r context="render"}
#radioButtons("worlduslevel", "US Detail", choices=c("Country", "State", "County"), selected="State")
uiOutput("worldoverviewinputs")
```


Row
-----------------------------------------------------------------------
### World Map

```{r worldmap,context="server",include=F}
world_cases <- reactive({
  req(input$worlddate)
  
  todisplay <- world_cases_jh() %>% 
    dplyr::filter(date == input$worlddate)
  
  todisplay %>% 
    inner_join(locations) %>%
    ungroup() %>% 
    select(confirmed, dead, lat, lng, Sublocation, Subsublocation, Location) %>% 
    mutate(
      popup=paste0('<font color="blue">', 
                   case_when(
                     ! is.na(Subsublocation) ~ paste0(Subsublocation, ", ", Sublocation, ", ", Location), 
                     ! is.na(Sublocation) ~ paste0(Sublocation, ", ", Location), 
                     TRUE ~ Location
                   ),
                   "</font><br/>", 
                   "Confirmed: ", confirmed, 
                   "<br/>Deaths: ", dead),
      popup=map(popup, HTML)
    ) 
})

output$worldview <- renderLeaflet({
  leaflet(
    options=leafletOptions(minZoom=2)
  ) %>% 
    addProviderTiles(providers$CartoDB.Positron)
})

sizer <- 2000

observeEvent(world_cases(), {
  leafletProxy("worldview", data=world_cases(), deferUntilFlush=T) %>%
    clearShapes() %>% 
    addCircles(group="Confirmed", weight=0, opacity=0, fillOpacity = 0.3, 
               color="Blue", radius = ~(sqrt(confirmed) * sizer),
               label=~popup) %>% 
    addCircles(group="Deaths", weight=0, opacity=0, fillOpacity = 0.3, 
               color="red", radius= ~(sqrt(dead) * sizer)) %>%
    addLayersControl(overlayGroups=c("Confirmed", "Deaths"))
})
```
```{r worldmap_output}
leafletOutput("worldview")
```

```{r worldview_handle_clicks,context="server",include=F}
click_d_threshold <- 20 

world_click_state <- reactive(label="worldmapclick", {
  if (is.null(input$worldview_click)) {NA}
  else {
    lat <- input$worldview_click$lat
    lng <- input$worldview_click$lng
    
    target <- st_point(x=c(lng, lat), dim=c("XY"))
    
    out <- locations %>% filter(
      is.na(Subsublocation), 
      Location != "US" | is.na(Sublocation)
    ) %>%
      mutate(
        pt = map2(lng, lat, ~st_point(c(.x, .y), dim="XY")), 
        d = unlist(map(pt, ~ st_distance(target, .x)))
      ) %>%
      top_n(n=1, wt=-d)
    
    if (out$d[1] < click_d_threshold) {out}
    else {NA}
  }
})

world_case_summary <- reactive(label="world_case_summary", {
  cases_input <- world_cases_jh()
  click_state <- world_click_state()
  
  (if (is.na(click_state)) {
    cases_input %>% 
     ungroup() %>%
     group_by(date) %>%
     select(-loc_id) %>%
     summarize_all(~sum(., na.rm=T))
  } else {
    cases_input %>% 
      filter(loc_id == click_state$loc_id[1]) %>% 
      ungroup()
  }) %>% 
  arrange(date) %>% 
  mutate(
    ma = rollmeanr(new_confirmed, k=5, fill=new_confirmed),
    growth_rate = new_confirmed / dplyr::lag(confirmed, 1), 
    grma = rollmeanr(growth_rate, k=5, fill=growth_rate)
  ) %>%
    filter(confirmed >= input$worldmincases)
})


world_click_name <- reactive({
  click_state = world_click_state()
  if (is.na(click_state)) {"Global"}
  else if (is.na(click_state$Sublocation[1])) {click_state$Location[1]}
  else {paste0(click_state$Sublocation[1], ", ", click_state$Location[1])}
})
```

Row {data-height=300}
----------------------------------------------------

### Cases

```{r worldcases,context="server",include=F}
output$worldcases <- renderHighchart({
  req(input$worldscale)
  highchart()  %>%
    hc_title(text = paste0("Cases (", isolate(world_click_name()), ")")) %>%
    hc_yAxis(title = "", type = input$worldscale) %>%
    hc_xAxis(type = "datetime") %>%
    hc_add_series(
      type = "line",
      mapping = hcaes(x = date, y = val, group = Series),
      data = world_case_summary() %>%
        select(
          date,
          Confirmed = confirmed,
          Deaths = dead,
          Recovered = recovered
        ) %>%
        mutate(Active = Confirmed - Deaths - Recovered) %>%
        gather(key = "Series", value = "val",-date),
        marker=list(enabled=F)
    ) %>%
    hc_tooltip(shared=TRUE)
})
```

```{r worldcasesoutput}
highchartOutput("worldcases")
```

### New Cases Per Day

```{r worldnewcases,context="server"}
output$dailynewcases <- renderHighchart({
  req(input$worldscale)
  highchart()  %>%
    hc_title(text = paste0("New Cases Per Day (", isolate(world_click_name()), ")")) %>%
    hc_yAxis(title = "") %>%
    hc_xAxis(type = "datetime") %>%
    hc_add_series(
      type = "column",
      mapping = hcaes(x = date, y = New),
      data = world_case_summary() %>%
        select(date, New = new_confirmed),
      name = "New Cases"
    ) %>%
    hc_add_series(
      type="line", 
      color="red", 
      marker=list(enabled=F), 
      mapping = hcaes(x = date, y = ma), 
      name="5-day moving average", 
      data = isolate(world_case_summary())
    )
})
```

```{r worldnewcasesoutput}
highchartOutput("dailynewcases")
```

### Growth Rate (new cases / prior cases)

```{r world_growth,context="server"}
output$world_growth <- renderHighchart({
  req(input$worldscale)
  highchart()  %>%
    hc_title(text = paste0("Growth Rate (", isolate(world_click_name()), ")")) %>%
    hc_yAxis(title = "") %>%
    hc_xAxis(type = "datetime") %>%
    hc_add_series(
      type="line", 
      marker=list(enabled=F), 
      data = world_case_summary() %>% 
        select(date, `Growth Rate` = growth_rate, `Growth Rate 5-day Rolling Average`=grma) %>%
        gather(key="key", value="value", -date) %>%
        mutate(value = round(value, 2)), 
      mapping = hcaes(x = date, y = value, group=key)
    ) %>%
    hc_tooltip(shared=T)
})
```

```{r world_growth_output}
highchartOutput("world_growth")
```

United States
================================================

Inputs {.sidebar}
-----------------------------------------------------------------------

### Input

```{r usinput,context="server",include=F}
output$usinputs <- renderUI({
  cases <- dataset$cases_county_nyt()
  
  tagList(
    sliderInput("usdate", "Date:",
                min=min(cases$date), 
                max=max(cases$date), 
                value=max(cases$date), 
                timeFormat="%Y-%m-%d", 
                animate=T),
    
    radioButtons("usscale", "Data Resolution", 
                 choices=c("State", "County"), 
                 selected="State"),
    
    radioButtons("uslog", "Scale", 
                 choices=list(
                   Linear="linear", 
                   Logarithmic="logarithmic"
                 ), 
                 selected="linear"),
    
    radioButtons("usshade", "Map Shading",
                 choices=c("Pop Density", 
                           "Housing Density", 
                           "Occupancy Density", 
                           "Infection Rate", 
                           "Cases"), 
                 selected="Pop Density"),
    sliderTextInput(
      "usmincases", 
      "Minimum Number of Cases", 
      choices = 10^(0:3),
      selected = 1
    )
  )
})
```

```{r usinputoutput}
uiOutput("usinputs")
```

Row
-----------------------------------------------

### US Map

```{r make_us_cases,context="server-start",include=F}
make_us_cases <- function(county_cases, state_cases, covid_tracker) geometries %>%
  inner_join(
    county_cases %>%
      bind_rows(state_cases) %>% 
      filter(cases > 0) %>%
      inner_join(locations) %>%
      rename(state = Sublocation, county = Subsublocation) %>%
      left_join(covid_tracker %>% 
                  select(date, loc_id, 
                         negative, pending, 
                         hospitalized = hospitalizedCurrently, 
                         icu = inIcuCurrently, 
                         vent = onVentilatorCurrently, 
                         recovered))
  ) %>%
  mutate(
    landsqmi = aland / 2591646,
    pop_density = pop / landsqmi,
    housing_density = housing_units / landsqmi,
    occupancy_density = pop / housing_units,
    rate = round((cases / pop) * 1e5),
    pos_rate = cases / (cases + negative)
  ) %>%
  select(-aland,-awater) %>%
  group_by(loc_id) %>%
  arrange(date) %>%
  mutate(
    new_cases = cases - lag(cases, 1, default = 0),
    growth_rate = (new_cases / lag(cases, 1, default = 1)),
    delta_growth_rate = (growth_rate / lag(growth_rate, 1, default = 1)),
    label = paste0(
      "<font color='blue'>", if_else(is.na(county), state, paste0(county, ", ", state)), "     ", format(date, "%B %d, %Y"), "</font><br/>",
      "<hr>",
      "Population: ", pop, "<br/>",
      "Density: ", round(pop_density, 4), " ppl/sqmi<br/>",
      "Housing Units: ",  round(housing_density, 4), " /sqmi<br/>",
      "<hr>",
      "Confirmed Cases: ", cases, "<br/>", 
      "Infection Rate: ", rate, " / 100,000 ppl<br/>",
      "Deaths: ", deaths, "<br/>",
      "<hr>",
      "New Cases: ", new_cases, "<br/>",
      "Growth: ", round(growth_rate, 3), " d/d<br/>",
      "Change in Growth: ", round(delta_growth_rate, 3), "<br/>"
    ),
    label = map(label, HTML)
  )


us_cases_with_geo <- reactive(make_us_cases(dataset$cases_county_nyt(), 
                                            dataset$cases_state_nyt(),
                                            dataset$covid_track()))
```

```{r usmap_vis_elements,context="server-start",includ=F}
shadeWeight <- 0.1
shadeOpacity <- 0.7
usbox <- st_bbox(continental_us$us)
uscenter <- st_centroid(continental_us$us)

pal_density_pop <- colorNumeric("RdYlBu", domain = log10(c(.1, 30000)))
pal_density_hous <- colorNumeric("Greens", domain = log10(c(1e-2, 1e4)))
pal_density_occ <- colorNumeric("Blues", domain = c(0, 3))
pal_rate <- colorNumeric("Oranges", domain = log10(c(1, 1e4)))
pal_cases <- colorNumeric("Reds", domain=log10(10^(0:6)))

vis_options <- list(
  "Pop Density" = list(
    pal = quote(~pal_density_pop(log10(pop_density))), 
    field = quote(log10(pop_density)),
    legend_pal = pal_density_pop, 
    legend_bins = 5,
    legend_vals = c(-1, log10(30000)),
    legend_trans = labelFormat(transform=function(x) 10^x, suffix = " ppl / sqmi")
  ), 
  "Housing Density" = list(
    pal = quote(~pal_density_hous(log10(housing_density))), 
    field = quote(log10(housing_density)),
    legend_pal = pal_density_hous, 
    legend_bins = 6,
    legend_vals = c(-2, 4),
    legend_trans = labelFormat(transform=function(x) 10^x, suffix = " homes / sqmi")
  ), 
  "Occupancy Density" = list(
    pal = quote(~pal_density_occ(log10(occupancy_density))), 
    field = quote(log10(occupancy_density)),
    legend_pal = pal_density_occ, 
    legend_bins = 4, 
    legend_vals = c(0, 3),
    legend_trans = labelFormat(suffix = "ppl / home")
  ), 
  "Infection Rate" = list(    
    pal = quote(~pal_rate(log10(rate))), 
    legend_pal = pal_rate, 
    legend_bins = 5, 
    legend_vals = c(0, 4),
    legend_trans = labelFormat(transform=function(x) 10^x, suffix = " / 100,000 ppl")
  ), 
  "Cases" = list(
    pal = quote(~pal_cases(log10(cases))), 
    legend_pal = pal_cases, 
    legend_bins = 6, 
    legend_vals = c(0, 5),
    legend_trans = labelFormat(transform=function(x) 10^x)
  )
)
```

```{r usmap_data_filtration,context="server",include=F}
us_cases_state_county <- reactive({
  req(input$usscale)
  scale <- input$usscale
  
  us_cases_with_geo() %>%
    filter(
      (scale == "County" & ! is.na(county)) | (scale == "State" & is.na(county)),
      cases >= input$usmincases
    ) 
})

us_cases <- reactive({
  req(input$usdate)
  req(input$usmincases)

  us_cases_state_county() %>% 
    filter(
      date == input$usdate
    ) 
})
```

```{r usmap,context="server",include=F}
output$usview <- renderLeaflet({
  leaflet(
    options=leafletOptions(minZoom=4)
  ) %>% 
    addProviderTiles(providers$CartoDB.Positron) %>%
    setMaxBounds(usbox[1], usbox[2], usbox[3], usbox[4]) %>%
    setView(lat=uscenter[[1]][2], lng=uscenter[[1]][1], zoom=4)
})

observe({
  req(input$usshade)
  selection <- input$usshade
  vis_parts <- vis_options[[selection]]
  
  map <- leafletProxy("usview", data=us_cases(), deferUntilFlush=T) %>%
    clearShapes() %>% 
    addPolygons(opacity = shadeOpacity,
                group = selection,
                weight = shadeWeight,
                fillColor = eval(vis_parts$pal),
                fillOpacity = shadeOpacity,
                label = ~label,
                highlight = highlightOptions(
                  weight=5, fillOpacity=1.0, bringToFront = TRUE
                )
    )
  
  if (selection != "Cases") {
    map %>% addCircles(group="Confirmed Cases",
                       lat=~lat, 
                       lng=~lng, 
                       stroke=F,
                       fillOpacity=0.2,
                       color="red",
                       radius=~(sqrt(cases) * 1000))
  }
})

observeEvent(input$usshade, {
  req(input$usshade) 
  selection <- input$usshade
  vis_parts <- vis_options[[selection]]
  
  map <- leafletProxy("usview", deferUntilFlush=T) %>%
    clearControls() %>%
    addLegend(title=selection, 
              pal=vis_parts$legend_pal, 
              values=vis_parts$legend_vals,
              bins=vis_parts$legend_bins,
              labFormat=vis_parts$legend_trans, 
              position="bottomleft"
    )
  
  
  if (selection != "Cases") {
    map %>%
      addLayersControl(overlayGroups="Confirmed Cases")
  }
})
```

```{r usmap_output}
leafletOutput("usview")
```


Row 
------------------------------------------------------------------

### US Cases

```{r data_for_us_charts,context="server",include=F}
region_click_state <- reactive(label="usmapclick", {
  
  if (is.null(input$usview_click)) {NA}
  else {
    lat <- input$usview_click$lat
    lng <- input$usview_click$lng
    
    target <- st_point(x=c(lng, lat), dim=c("XY"))
    
    out <- us_cases_state_county() %>% 
        group_by(loc_id) %>%
        filter(row_number() == 1) %>%
        filter(map_lgl(bbox, ~ between(target[1], .x$xmin, .x$xmax) & between(target[2], .x$ymin, .x$ymax))) %>% 
        filter(st_within(target, geometry, sparse=F, prepared=F)) %>% 
        select(state, county, loc_id)
    if (nrow(out) == 0) {NA}
    else {out}
  }
})

us_case_summary <- reactive(label="us_case_summary", {
  cases <- us_cases_state_county() %>% select(-geometry) %>% as.data.frame()
  click_state <- region_click_state()

  if (is.na(click_state)) {
    cases %<>% 
      group_by(date) %>% 
      summarize_if(is.numeric, ~sum(., na.rm=T))
  } else {
    cases %<>% 
      filter(loc_id == click_state$loc_id[1])
  }

  cases %>% 
    select(date, Cases=cases, Deaths=deaths, 
           Hospitalized=hospitalized, ICU=icu, 
           Ventilator=vent, Recovered = recovered, 
           `New Cases` = new_cases) %>% 
  mutate(
    ma = rollmeanr(`New Cases`, k=5, fill=`New Cases`),
    growth_rate = `New Cases` / dplyr::lag(Cases, 1), 
    grma = rollmeanr(growth_rate, k=5, fill=growth_rate)
  )
  
})

click_state_name <- reactive({
  click_state = region_click_state()
  if (is.na(click_state)) "U.S." 
  else {
    if_else(is.na(click_state$county[1]), click_state$state[1],
            paste0(click_state$county[1], ", ", click_state$state[1]))
  }
})
```

```{r us_cumulative_server,context="server"}
output$uscaseslinear <- renderHighchart({
  req(input$uslog)
  highchart() %>% 
    hc_title(text=paste0("Confirmed Cases, Hosp. and Deaths (", isolate(click_state_name()), ")")) %>%
    hc_yAxis(title="", type=input$uslog, min=1) %>%
    hc_xAxis(type="datetime") %>% 
    hc_add_series(
      type="line",
      marker=list(enabled=F), 
      data=us_case_summary() %>% 
        select(-ma, -growth_rate, -grma) %>% 
        gather(key="Series", value="val", -date) %>%
        filter(val > 0), 
      mapping=hcaes(x=date, y=val, group=Series)
    ) %>%
    hc_tooltip(shared=T)
})
```

```{r us_cumulative_output}
highchartOutput("uscaseslinear")
```


### New Cases Per Day

```{r usewcases,context="server",include=F}
output$usdailynewcases <- renderHighchart(
  highchart() %>% 
    hc_title(text=paste0("Daily New Cases (", isolate(click_state_name()), ")")) %>%
    hc_xAxis(type="datetime") %>%
    hc_yAxis(title="", type=input$uslog, min=1) %>% 
    hc_add_series(type="column", 
                  data=us_case_summary(), 
                  mapping=hcaes(x=date, y=`New Cases`),
                  name="New Cases") %>%
    hc_add_series(
      type="line", 
      color="red", 
      marker=list(enabled=F), 
      data=isolate(us_case_summary() %>% select(-grma, -growth_rate)),
      mapping=hcaes(x=date, y=ma), 
      name="5-day moving average"
    )
)
```

```{r usnewcasesoutput}
highchartOutput("usdailynewcases")
```

### Growth Rate (new cases / prior cases)

```{r us_growth_server,context="server",include=F}
output$us_growth_rate <- renderHighchart(
  highchart() %>% 
    hc_title(text=paste0("Growth Rate (", isolate(click_state_name()), ")")) %>%
    hc_xAxis(type="datetime") %>%
    hc_yAxis(title="", type="linear") %>% 
    hc_add_series(
      type="line", 
      marker=list(enabled=F), 
      data=us_case_summary() %>% 
        select(
          date, 
          `Growth Rate` = growth_rate, 
          `Growth Rate 5-day Moving Average` = grma
        ) %>% 
        gather(key="key", value="value", -date),
      mapping=hcaes(x=date, y=value, group=key)
    )
)
```

```{r us_growth_output}
highchartOutput("us_growth_rate")
```

US Testing
=====================================================

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r ustesting_input}
checkboxGroupInput("testingstates", label = "States to Show", 
                   choices = state.name, 
                   selected=state.name)
```

Row
-----------------------------------------------------

```{r ustesting_filter,context="server",include=F}
covid_track_filtered <- reactive(dataset$covid_track() %>% 
                                   semi_join(
                                     locations %>% filter(Sublocation %in% input$testingstates,
                                                          is.na(Subsublocation))
                                   )
)
```

### US Testing (Cumulative)

```{r ustesting,context="server",include=F}
output$ustesting <- renderHighchart(
  highchart()  %>%
    hc_plotOptions(column=list(stacking="normal")) %>%
    hc_title(text="Cumulative US Testing") %>%
    hc_yAxis(title="") %>%
    hc_xAxis(type="datetime") %>% 
    hc_add_series(data = covid_track_filtered() %>% 
                    select(date, positive, negative, pending) %>% 
                    group_by(date) %>% 
                    summarize_all(~sum(., na.rm=T)) %>%
                    gather(key="Series", val="val", -date), 
                  type="column", 
                  mapping=hcaes(x=date, y=val, group=Series, fill=Series))
)
```
```{r ustestingoutput}
highchartOutput("ustesting")
```

### US Testing (Incremental)

```{r ustestinginc_server,context="server",include=F}
output$ustestinginc <- renderHighchart(
  highchart()  %>%
    hc_plotOptions(column=list(stacking="normal")) %>%
    hc_title(text="Incremental US Testing") %>%
    hc_yAxis(title="") %>%
    hc_xAxis(type="datetime") %>% 
    hc_add_series(data = covid_track_filtered() %>% 
                    select(date, positive, negative) %>% 
                    group_by(date) %>% 
                    summarize_all(~sum(., na.rm=T)) %>%
                    arrange(date) %>%
                    mutate_if(is.numeric, ~ . - lag(., 1L, default=0)) %>%
                    gather(key="Series", val="val", -date), 
                  type="column", 
                  mapping=hcaes(x=date, y=val, group=Series, fill=Series))
)
```
```{r ustestinginc_output}
highchartOutput("ustestinginc")
```

Row
---------------------------------------------------

### Tests Per Day By State

```{r testsperdaybystate_server,context="server",include=F}
output$ustestingbystateinc <- renderHighchart(
  highchart() %>%
    hc_title(text="Daily Testing By State") %>%
    hc_xAxis(type="datetime") %>% 
    hc_yAxis(title="", min=0) %>%
    hc_add_series(
      data=covid_track_filtered() %>% 
        select(date, positiveIncrease, negativeIncrease, loc_id) %>% 
        mutate(tests = positiveIncrease + negativeIncrease) %>%
        select(-positiveIncrease, -negativeIncrease) %>% 
        inner_join(locations %>% select(loc_id, state=Sublocation)) %>% 
        select(-loc_id),
      mapping=hcaes(x=date, y=tests, group=state),
      type="line",
      marker=list(enabled=F)
    ) %>%
    hc_tooltip(shared=T)
)
```
```{r testsperdaybystate_output}
highchartOutput("ustestingbystateinc")
```

New York City Testing
===================================================

### New York City

```{r nymap_startup,context="server-start",include=F}
nyzip_geoms <- reactive(
  zips %>% 
    inner_join(dataset$nyzipcode() %>% mutate(zipcode=as.character(zipcode))) %>% 
    mutate(
      lat = map(geometry, ~ .[[1]][1]), 
      lng = map(geometry, ~.[[2]][1]), 
      lat = unlist(lat), 
      lng = unlist(lng), 
      rate = Positive / Total,
      label = paste0(
        "<font color='blue'>Zipcode: ", zipcode, "</font><br/>",
        "Positive Tests: ", Positive, " / ", Total
      ),
      label = map(label, HTML)
    )
)

ny_bbox <- st_bbox(zips$geometry)
ny_centroid <- st_centroid(zips$geometry)
rate_pal <- colorNumeric("Reds", domain=c(0, 1))
```

```{r nymap_server,context="server",include=F}
output$nyview <- renderLeaflet({
  leaflet(nyzip_geoms()) %>% 
    addProviderTiles(providers$CartoDB.Positron) %>% 
    setMaxBounds(ny_bbox[1], ny_bbox[2], ny_bbox[3], ny_bbox[4]) %>%
    setView(lat=ny_centroid[[1]][2], lng=ny_centroid[[1]][1], zoom=10) %>%
    addLegend(pal=rate_pal, values=c(0, .25, .5, .75, 1), 
              title="Positive Rate")  %>%
    addCircles(weight=0, opacity=.3, stroke=F, fill=T, 
               fillOpacity = 0.4, fillColor=~rate_pal(rate), 
               label=~label,
               radius = ~(sqrt(Positive) * 30)) 
})
```

```{r nymap_output}
leafletOutput("nyview")
```


Interventions
====================================================

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r intervention_start,context="server-start",include=F}
avail_states <- reactive(dataset$interventions() %>%
                           inner_join(locations) %>%
                           use_series(Sublocation) %>% unique() %>% sort())
```

```{r interventioninputs_server,context="server"}
output$interventioninputs <- renderUI({
  tagList(
    checkboxGroupInput("interventionstates", label = "States to Show", 
                       choices = avail_states(), 
                       selected=c("New York", "California")),
    radioButtons("interventionlog", label="Log or Linear", choices=c("logarithmic", "linear"), selected="logarithmic"),
    sliderInput("interventionstartcases", label="Start # of Cases", 
                min=1, max=1000, value=10)
  )
})
```

```{r interventionsinputs_output}
uiOutput("interventioninputs")
```

Row 
---------------------------------------------------------------------- 

```{r interventions_startup,context="server-start",include=F}
interventions_with_cases <- reactive({
  interventions <- dataset$interventions()
  
  locs_with_intervention <- interventions %>% group_by(loc_id) %>% summarize()
  
  us_cases_with_geo() %>%
    select(-geometry) %>% 
    semi_join(locs_with_intervention) %>%
    left_join(interventions) %>%
    mutate(name = paste0(county, ", ", state))
})
```

```{r interventions_data,context="server",include=F}
filtered_interventions_with_cases <- reactive({
  req(input$interventionstartcases)
  req(input$interventionstates)
  
  interventions_with_cases() %>% 
    semi_join(
      locations %>% 
        filter(Sublocation %in% input$interventionstates)
    ) %>% 
    group_by(loc_id) %>%
    arrange(date) %>% 
    filter(cases >= input$interventionstartcases) %>%
    mutate(days = as.numeric(date - min(date)))
})

intervention_points <- reactive(filtered_interventions_with_cases() %>% 
                                  filter(! is.na(intervention)))
```

```{r interventions_server,context="server",include=F}
output$interventions <- renderHighchart({
  req(input$interventionlog)
  highchart() %>% 
    hc_add_series(data=filtered_interventions_with_cases(), 
                  type="line", 
                  mapping=hcaes(x=days, y=cases, group=name), 
                  colorAxis=0,
                  lineWidth=1, 
                  marker=list(enabled=F),
                  tooltip=list(
                    pointFormat="Date: {point.date}<br/>Cases: {point.cases}"
                  )) %>% 
    hc_yAxis(title="Cases", type=input$interventionlog, min=1) %>%
    hc_add_series(data=intervention_points(), type="point", 
                  mapping=hcaes(x=days, y=cases, fill=name,
                                color=name, group=intervention), 
                  colorAxis=0, tooltip=list(
                    headerFormat="<span style='color:{point.color}'>●</span> <span style='font-size: 12px'> {series.name}</span><br/>",
                    pointFormat="{point.name}<br/>Date: {point.date}<br/>Cases: {point.cases}"
                  )) %>%
    hc_title(text="Number of Cases")
})
```

### Effect of Interventions on Number of Cases

```{r interventions_output}
highchartOutput("interventions")
```

Row 
---------------------------------------------------------------------- 

```{r interventions_rate_server,context="server",include=F}
output$interventions_rate <- renderHighchart({
  highchart() %>% 
    hc_add_series(data=filtered_interventions_with_cases(), type="line", 
                  mapping=hcaes(x=days, y=growth_rate, group=name), 
                  colorAxis=0,
                  lineWidth=1, 
                  marker=list(enabled=F),
                  tooltip=list(
                    pointFormat="Date: {point.date}<br/>Cases: {point.cases}<br/>Growth Rate: {point.growth_rate}"
                  )) %>% 
    hc_yAxis(title="Growth Rate", type="logarithmic") %>%
    hc_add_series(data=intervention_points(), type="point", 
                  mapping=hcaes(x=days, y=growth_rate, fill=name,
                                color=name, group=intervention), 
                  colorAxis=0, tooltip=list(
                    headerFormat="<span style='color:{point.color}'>●</span> <span style='font-size: 12px'> {series.name}</span><br/>",
                    pointFormat="{point.name}<br/>Date: {point.date}<br/>Cases: {point.cases}<br/>Growth Rate: {point.growth_rate}"
                  )) %>%
    hc_title(text="Growth Rate")
})
```

### Case Growth Rate (New Cases / Prior Day's Cases)

```{r interventions_growth_output}
highchartOutput("interventions_rate")
```
