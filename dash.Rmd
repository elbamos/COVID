---
title: "COVID-19"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r todods,include=F}
# TODO: Add charts for individual states & counties
# TODO: Add proportions of populations as a view for US
# TODO: Add a page for test rate
# TODO: Add chart showing interventions
```

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)

# Tidyverse
library(readr)
library(dplyr)
library(magrittr)
library(lubridate)
library(tidyr)
library(purrr)

# Visualizations 
library(leaflet)
library(highcharter)
library(htmltools)
library(sf)

# Other
library(jsonlite)
```


```{r global,include=F}
# ----- ALL INITIAL DATA LOADING AND ANY SYNC'D EXPENSIVE MUNGING TAKES PLACE HERE -----
counties <- USAboundaries::us_counties()
states <- USAboundaries::us_states()

# --- JOHNS HOPKINS ---
confirmed <- read_csv("./COVID-19/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")

locations <- confirmed[, 1:4] %>%
  set_colnames(c("Sublocation", "Location", "lat", "lng")) %>%
  mutate(us_level="Country", Subsublocation=NA) %>% 
  bind_rows(
    states %>% 
      select(state_name, geometry) %>% 
      mutate(
        centroid = sf::st_centroid(geometry), 
        lat = map(centroid, ~.x[[1]][1]), 
        lng = map(centroid, ~.x[[1]][2]), 
        lat = unlist(lat), 
        Location="US", Subsublocation=NA, 
        lng = unlist(lng)) %>%
      rename(Sublocation=state_name) %>%
      mutate(us_level="State")
  ) %>%
  bind_rows(
    counties %>% 
      select(name, state_name, geometry) %>% 
      mutate(
        centroid = sf::st_centroid(geometry), 
        lat = map(centroid, ~.x[[1]][1]), 
        lng = map(centroid, ~.x[[1]][2]), 
        lat = unlist(lat), 
        Location="US",
        lng = unlist(lng), 
        us_level="County") %>%
      rename(Sublocation=state_name, Subsublocation=name)
  ) %>% 
  mutate(loc_id = 1:n()) %>%
  select(Location, Sublocation, Subsublocation, lat, lng, us_level, loc_id)

counties %<>% 
  left_join(locations %>% select(state_name = Sublocation, name = Subsublocation, loc_id))

states %<>% 
  left_join(locations %>% select(state_name = Sublocation, loc_id))

confirmed_by_date <- confirmed %>% 
  inner_join(
    locations %>% select(`Province/State`=Sublocation, `Country/Region`=Location, loc_id)
  ) %>%
  select(loc_id, matches("[0-9]+.[0-9]+.[0-9]+")) %>% 
  gather(key="date", value="confirmed", -loc_id)

dead <- read_csv("./COVID-19/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv") %>% 
  inner_join(
    locations %>% select(`Province/State`=Sublocation, `Country/Region`=Location, loc_id)
  ) %>%
  select(loc_id, matches("[0-9]+.[0-9]+.[0-9]+")) %>% 
  gather(key="date", value="dead", -loc_id)

world_cases_jh <- full_join(confirmed_by_date, dead) %>%
  group_by(loc_id) %>% 
  mutate(date = mdy(date)) %>%
  arrange(date) %>%
  mutate(
    new_dead = dead - lag(dead, 1, default=0),
    new_confirmed = confirmed - lag(confirmed, 1, default=0)
  )


# ------ NY TIMES
cases_county_nyt <- read_csv("./covid-19-data/us-counties.csv") %>% 
  left_join(locations %>% 
              select(county = Subsublocation, state=Sublocation, loc_id)) %>%
  select(-county, -state)
  
cases_state_nyt <- read_csv("./covid-19-data/us-states.csv") %>% 
  left_join(locations %>% 
              filter(is.na(Subsublocation)) %>% 
              select(state=Sublocation, loc_id)) %>% 
  select(-state)


# ------ COVID Tracking Project
covid_track = fromJSON("https://covidtracking.com/api/states/daily") %>%
  mutate(
    date = ymd(date)
  ) %>% inner_join(
    data.frame(state = state.abb, state_full=state.name)
  ) %>% 
  select(-state) %>% 
  rename(state=state_full) %>%
  left_join(
    locations %>% select(state=Sublocation, loc_id)
  )
```


World Overview
=======================================================================


Inputs {.sidebar}
-----------------------------------------------------------------------

### Input

```{r}
sliderInput("worlddate", 
            "Date:", 
            min=min(world_cases_jh$date), 
            max=max(world_cases_jh$date), 
            value=max(world_cases_jh$date) - 1, 
            timeFormat="%Y-%m-%d",
            animate=T)
#radioButtons("worlduslevel", "US Detail", choices=c("Country", "State", "County"), selected="State")
```


Row
-----------------------------------------------------------------------
### World Map

```{r worldmap}
world_cases <- reactive({
  req(input$worlddate)
  #req(input$worlduslevel) 
  todisplay <- world_cases_jh %>% 
    dplyr::filter(date == input$worlddate)
  
#  if (input$worlduslevel == "State") {
#    todisplay %<>% anti_join(
#      locations %>% filter(Location == "US")
#    ) %>% bind_rows(
#      cases_state_nyt %>% rename(dead=deaths, confirmed=cases)
#    )
#  } else if (input$worlduslevel == "County") {
#    todisplay %<>% anti_join(
#      locations %>% filter(Location == "US")
#    ) %>% bind_rows(
#      cases_county_nyt %>% rename(dead=deaths, confirmed=cases)
#    )
 # }
  
  todisplay %>% 
    inner_join(locations) %>%
    ungroup() %>% 
    select(confirmed, dead, lat, lng, Sublocation, Subsublocation, Location) %>% 
    mutate(
      popup=paste0('<font color="blue">', 
                   case_when(
                     ! is.na(Subsublocation) ~ paste0(Subsublocation, ", ", Sublocation, ", ", Location), 
                     ! is.na(Sublocation) ~ paste0(Sublocation, ", ", Location), 
                     TRUE ~ Location
                   ),
                   "</font><br/>", 
                   "Confirmed: ", confirmed, 
                   "<br/>Deaths: ", dead),
      popup=map(popup, HTML)
    )
})

output$worldview <- renderLeaflet({
  leaflet(
    options=leafletOptions(minZoom=2)
  ) %>% 
    addProviderTiles(providers$CartoDB.Positron)
})

sizer <- 2000

observe({
  leafletProxy("worldview", data=world_cases(), deferUntilFlush=T) %>%
    clearShapes() %>% 
    addCircles(opacity=0.2, group="Confirmed",
             color="Blue", radius = ~(sqrt(confirmed) * sizer),
             label=~popup) %>% 
    addCircles(opacity=0.2, group="Deaths", 
              color="red", radius= ~(sqrt(dead) * sizer)) %>%
    addLayersControl(overlayGroups=c("Confirmed", "Deaths"))
})

leafletOutput("worldview")
```

Row {data-height=300}
----------------------------------------------------

### World Cases Flat

```{r worldcasesflat}
world_case_summary <- world_cases_jh %>%
  ungroup() %>%
  group_by(date) %>%
  select(-loc_id) %>%
  summarize_all(sum)

output$worldcaseslinear <- renderHighchart(
  world_case_summary %>% select(date, Confirmed=confirmed, Deaths=dead) %>%
    gather(key="Series", value="val", -date) %>%
    hchart("line", hcaes(x=date, y=val, group=Series)) %>%
    hc_title(text="Confirmed Cases and Deaths (Global, Linear Scale)") %>%
    hc_yAxis(title="")
)

highchartOutput("worldcaseslinear")
```

### World Cases Logarithmic

```{r worldcaseslog}
output$worldcaseslog <- renderHighchart(
  world_case_summary %>% select(date, Confirmed=confirmed, Deaths=dead) %>%
    gather(key="Series", value="val", -date) %>%
    hchart("line", hcaes(x=date, y=val, group=Series)) %>% 
    hc_yAxis(type = "logarithmic", gridLineWidth = 0, title="") %>%
    hc_title(text="Confirmed Cases and Deaths (Global, Logarithmic Scale)")
)

highchartOutput("worldcaseslog")
```

### New Cases Per Day

```{r worldnewcases}
output$dailynewcases <- renderHighchart(
  world_case_summary %>% select(date, New=new_confirmed) %>%
    hchart("column", hcaes(x=date, y=New)) %>%
    hc_title(text="New Cases Per Day") %>%
    hc_yAxis(title="")
)

highchartOutput("dailynewcases")
```


United States
================================================

Inputs {.sidebar}
-----------------------------------------------------------------------

### Input

```{r}
sliderInput("usdate", 
            "Date:", 
            min=min(cases_county_nyt$date), 
            max=max(cases_county_nyt$date), 
            value=max(cases_county_nyt$date) - 1, 
            timeFormat="%Y-%m-%d",
            animate=T)
```

Row
-----------------------------------------------

### US Map

```{r usmap}
us_map_filter <- counties %>% left_join(
  cases_county_nyt %>%
    filter(cases > 0) %>% 
    inner_join(locations) %>% 
    rename(state=Sublocation, county=Subsublocation) %>% 
    mutate(
      label = paste0("<font color='blue'>", 
                     county, ", ", state, "</font><br/>", 
                     "Confirmed Cases: ",  cases, "<br/>", 
                     "Deaths: ", deaths, "<br/>"),
      label = map(label, HTML)
    )
)

us_cases <- reactive({
  req(input$usdate)
  us_map_filter %>% filter(date == input$usdate) 
})

bins <- c(1, 50, 100, 500, 1000, 5000, 10000, 25000, Inf)
pal <- colorBin("YlOrRd", domain = us_map_filter$cases, bins = bins)

output$usview <- renderLeaflet({
  leaflet(
    options=leafletOptions(minZoom=4)
  ) %>% 
    addProviderTiles(providers$CartoDB.Positron) %>%
    addLegend(pal=pal, values=bins, opacity=0.7) %>% 
    setMaxBounds(-167.276413, 5.499550, -52.233040, 83.162102) %>%
    setView(lat=41.836944, lng=-87.684722, zoom=4)
})

observe({
  leafletProxy("usview", data=us_cases(), deferUntilFlush=T) %>%
  clearShapes()  %>%
  addPolygons(opacity = .4,
              group="Confirmed Cases", 
              weight = .3,
              fillColor = ~pal(cases),
              fillOpacity = .7,
              label = ~label, 
              highlight = highlightOptions(
                weight=5, fillOpacity=1.0, bringToFront = TRUE
                )
              ) %>%
    addLayersControl(overlayGroups=c("Confirmed Cases")) 
})

leafletOutput("usview")
```


Row 
------------------------------------------------------------------

### US Cases Flat

```{r uscasesflat}
us_case_summary <- cases_state_nyt %>%
  ungroup() %>%
  select(date, cases, deaths) %>% 
  group_by(date) %>%
  summarize_all(sum)

output$uscaseslinear <- renderHighchart(
  us_case_summary %>% select(date, Confirmed=cases, Deaths=deaths) %>%
    gather(key="Series", value="val", -date) %>%
    hchart("line", hcaes(x=date, y=val, group=Series)) %>%
    hc_title(text="Confirmed Cases and Deaths (U.S., Linear Scale)") %>%
    hc_yAxis(title="")
)

highchartOutput("uscaseslinear")
```

### US Cases Logarithmic

```{r uscaseslog}
output$uscaseslog <- renderHighchart(
  us_case_summary %>% select(date, Confirmed=cases, Deaths=deaths) %>%
    gather(key="Series", value="val", -date) %>%
    hchart("line", hcaes(x=date, y=val, group=Series)) %>% 
    hc_yAxis(type = "logarithmic", gridLineWidth = 0, title="") %>%
    hc_title(text="Confirmed Cases and Deaths (U.S., Logarithmic Scale)")
)

highchartOutput("uscaseslog")
```

### New Cases Per Day

```{r usewcases}
output$usdailynewcases <- renderHighchart(
  us_case_summary %>% 
    arrange(date) %>%
    mutate(new_confirmed = cases - lag(cases, 1, default=0)) %>%
    select(date, New=new_confirmed) %>%
    hchart("column", hcaes(x=date, y=New)) %>%
    hc_title(text="New Cases Per Day")
)

highchartOutput("usdailynewcases")
```