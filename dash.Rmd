---
title: "COVID-19"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r todods,include=F}
# TODO: Add charts for individual states & counties
# TODO: Add proportions of populations as a view for US
# TODO: Animate the bar charts next to the maps
```

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)

# Tidyverse
library(readr)
library(dplyr)
library(magrittr)
library(lubridate)
library(tidyr)
library(purrr)
library(stringr)

# Visualizations 
library(leaflet)
library(highcharter)
library(htmltools)
library(sf)

# Other
library(jsonlite)
```


```{r setupdata,include=F}
dataset <- reactiveValues()
datasetdt <- reactiveValues()
updateFreq = 10 * 60 * 1000

update_dataset_dt_file <- function(tag, file) {
  datasetdt[[tag]] <- file.mtime(file)
}

update_dataset_dt_url <- function(tag, url) {
  resp <- httr::HEAD(url)
  datasetdt[[tag]] <- dmy_hms(resp$headers$date)
}

get_url_date <- function(url) {
  resp <- httr::HEAD(url)
  dmy_hms(resp$headers$date)
}

get_new_data <- function(tag, url, f) {
  print(paste("getting data", tag))
  out <- read_csv(url) %>% 
    f()
  update_dataset_dt_url(tag, url)
  print(paste("got data", tag))
  out 
}

get_new_data_json <- function(tag, url, f) {
  out <- fromJSON(url) %>% 
    f()
  update_dataset_dt_url(tag, url)
  out 
}
```

```{r global,include=F}
counties <- USAboundaries::us_counties()
states <- USAboundaries::us_states()
zips <- USAboundaries::us_zipcodes() %>%
  filter(str_starts(zipcode, "10") | str_starts(zipcode, "11"))

geometries <- counties %>%
  select(county=name, state=state_name, geometry, aland, awater) %>%
  rbind(
    states %>% select(state=state_name, geometry, aland, awater) %>%
      mutate(county=NA), 
    counties %>% 
      filter(
        state_name == "New York", 
        name %in% c("Kings", "Queens", "New York", "Bronx", "Staten Island", "Richmond")
      ) %>% 
      summarize(
        geometry = st_combine(geometry), 
        aland = sum(aland), 
        awater = sum(awater)
      ) %>%
      mutate(
        state = "New York", 
        county = "New York City"
      )
  ) %>% 
  mutate(
    centroid = sf::st_centroid(geometry), 
    lat = map(centroid, ~.x[[1]][1]), 
    lng = map(centroid, ~.x[[2]][1]), 
    lat = unlist(lat), 
    lng = unlist(lng)
  ) %>% select(-centroid) 

rm(counties)
rm(states)

continental_us <- geometries %>%
  filter(! state %in% c("Alaska", "Hawaii")) %>% 
  ungroup() %>% 
  summarize(us = st_combine(geometry)) 
```

```{r data_jh_and_locations,include=F}
url_world_confirmed <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"
url_world_dead <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv"
url_world_recovered <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv"

confirmed <- read_csv("./COVID-19/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")

locations <- confirmed[, 1:4] %>%
  set_colnames(c("Sublocation", "Location", "lat", "lng")) %>%
  mutate(us_level="Country", Subsublocation=NA) %>% 
  bind_rows(
    geometries %>% 
      rename(Sublocation=state, Subsublocation=county) %>%
      mutate(
        Location="US",
        us_level = if_else(is.na(Subsublocation), "State", "County")
      ) %>% select(Location, Sublocation, Subsublocation, us_level, lat, lng)
  ) %>%
  mutate(loc_id = 1:n()) %>%
  select(Location, Sublocation, Subsublocation, lat, lng, us_level, loc_id)

geometries %<>%
  left_join(locations %>% 
              select(state = Sublocation, 
                     county = Subsublocation, 
                     loc_id)
            )

process_jh_confirmed <- function(x) x %>% 
    inner_join(
      locations %>% 
        select(`Province/State`=Sublocation, `Country/Region`=Location, loc_id)
    ) %>%
    select(loc_id, matches("[0-9]+.[0-9]+.[0-9]+")) %>% 
    gather(key="date", value="confirmed", -loc_id)

process_jh_dead <- function(x) x %>% 
  inner_join(
      locations %>% 
        select(`Province/State`=Sublocation, `Country/Region`=Location, loc_id)
    ) %>%
    select(loc_id, matches("[0-9]+.[0-9]+.[0-9]+")) %>% 
    gather(key="date", value="dead", -loc_id)

process_jh_recovered <- function(x) x %>% 
    inner_join(
      locations %>% 
        select(`Province/State`=Sublocation, `Country/Region`=Location, loc_id)
    ) %>%
    select(loc_id, matches("[0-9]+.[0-9]+.[0-9]+")) %>% 
    gather(key="date", value="recovered", -loc_id)

dataset$confirmed <- reactivePoll(
  intervalMillis = updateFreq, session=NULL,
  checkFunc = function() get_url_date(url_world_confirmed), 
  valueFunc = function() get_new_data("Confirmed Cases (JH)",
                                      url_world_confirmed, 
                                      process_jh_confirmed)
)

dataset$dead <- reactivePoll(
  intervalMillis = updateFreq, session=NULL,
  checkFunc = function() get_url_date(url_world_dead), 
  valueFunc = function() get_new_data("Confirmed Dead (JH)",
                                      url_world_dead, 
                                      process_jh_dead)
)

dataset$recoveries <- reactivePoll(
  intervalMillis = updateFreq, session=NULL,
  checkFunc = function() get_url_date(url_world_recovered), 
  valueFunc = function() get_new_data("Confirmed Recovered (JH)",
                                      url_world_recovered, 
                                      process_jh_recovered)
)



world_cases_jh <- reactive({
  print("doing world")
  out <- 
   full_join(dataset$confirmed(), dataset$dead()) %>%
     full_join(dataset$recoveries()) %>%
     group_by(loc_id) %>% 
     mutate(date = mdy(date)) %>%
     arrange(date) %>%
     mutate_if(is.numeric, ~ if_else(is.na(.), 0, .)) %>% 
     mutate(
       new_dead = dead - lag(dead, 1, default=0),
       new_confirmed = confirmed - lag(confirmed, 1, default=0)
     )
  print("done world")
  out
})
```

```{r data_nytimes,include=F}
# ------ NY TIMES
url_ny_county <- "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"
url_ny_state <- "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv"

process_ny_county <- function(x) {
  print("doing ny county")
  out <- x %>% 
    left_join(locations %>% 
                select(county = Subsublocation, state=Sublocation, loc_id)) %>%
    select(-county, -state)
  print("done ny county")
  out
}

process_ny_state <- function(x) {
  print("doing ny state")
  out <- x %>% 
  filter(! state %in% c(78, 66)) %>% # Exclude virgin islands and guam
  left_join(locations %>% 
              filter(is.na(Subsublocation)) %>% 
              select(state=Sublocation, loc_id)) %>% 
  select(-state)
  print("done ny state")
  out
}

dataset$cases_county_nyt <- reactivePoll(
  intervalMillis = updateFreq, session=NULL,
  checkFunc = function() get_url_date(url_ny_county), 
  valueFunc = function() get_new_data("NYT Counties", 
                                      url_ny_county, 
                                      process_ny_county)
)

dataset$cases_state_nyt <- reactivePoll(
  intervalMillis = updateFreq, session=NULL,
  checkFunc = function() get_url_date(url_ny_state), 
  valueFunc = function() get_new_data("NYT States", 
                                      url_ny_state, 
                                      process_ny_state) 
)
```


```{r data_covid_track,include=F}
# ------------ COVID Tracking Project
url_covid_track <- "https://covidtracking.com/api/states/daily"

process_covid_track <- function(x) x %>%
  mutate(
    date = ymd(date)
  ) %>% inner_join(
    data.frame(state = state.abb, state_full=state.name)
  ) %>% 
  select(-state) %>% 
  rename(state=state_full) %>%
  left_join(
    locations %>% filter(is.na(Subsublocation)) %>% select(state=Sublocation, loc_id)
  )

dataset$covid_track <- reactivePoll(
  intervalMillis = updateFreq, session=NULL,
  checkFunc = function() get_url_date(url_covid_track),
  valueFunc = function() get_new_data_json(tag="COVID Track", 
                                           url=url_covid_track, 
                                           f=process_covid_track)
)
```


```{r data_interventions,include=F}
# ---------------  Intervention data
url_interventions <- "https://raw.githubusercontent.com/Keystone-Strategy/covid19-intervention-data/master/npi_data_03-24-2020.csv"

process_interventions <- function(x) x %>%
  select(-matches("X[0-9]+")) %>%
  mutate(
    state.abb = str_match(Intervention, "., ([A-Z]+)")[, 2], 
    county = str_match(Intervention, "(.+)\\sCounty.")[,2],
    county = case_when(
      ! is.na(county) ~ county, 
      str_detect(Intervention, "DC") ~ "Washington", 
      str_detect(Intervention, "New York City") ~ "New York City", 
      TRUE ~ county
    ), 
    state.abb = if_else(is.na(state.abb), "DC", state.abb)
  ) %>% 
  select(-Intervention) %>% 
  gather(key="intervention", value="date", -state.abb, -county) %>% 
  filter(! is.na(date)) %>%
  inner_join(data.frame(state.abb=state.abb, state.name=state.name)) %>% 
  mutate(
    date = mdy(date)
  ) %>% 
  inner_join(locations %>% select(county=Subsublocation, state.name=Sublocation, loc_id)) %>% 
  select(-matches("state"), -county)


dataset$interventions <- reactivePoll(
  intervalMillis = updateFreq, session=NULL,
  checkFunc = function() get_url_date(url_interventions), 
  valueFunc = function() get_new_data("Interventions", 
                                      url_interventions, 
                                      process_interventions)
)
```

```{r data_nyhealth}
url_nyzipcode <- "https://raw.githubusercontent.com/nychealth/coronavirus-data/master/tests-by-zcta.csv"

process_nyzipcode <- function(x) x %>% 
  filter(! is.na(MODZCTA)) %>% 
  rename(zipcode=MODZCTA)

dataset$nyzipcode <- reactivePoll(
  intervalMillis = updateFreq, session=NULL,
  checkFunc = function() get_url_date(url_nyzipcode), 
  valueFunc = function() get_new_data("NY Testing by Zipcode", 
                                      url_interventions, 
                                      process_nyzipcode)
)
```

World Overview
=======================================================================


Inputs {.sidebar}
-----------------------------------------------------------------------

### Input

```{r}
output$worldoverviewinputs <- renderUI({
  cases <- world_cases_jh()
  
  tagList(
    sliderInput("worlddate", "Date",
                min=min(cases$date), 
                max=max(cases$date), 
                value=max(cases$date), 
                timeFormat="%Y-%m-%d", 
                animate=T),
    radioButtons("worldscale", "Scale", 
                 choices=list(
                   Linear="linear",
                   Logarithmic="logarithmic"
                 ))
  )
})

#radioButtons("worlduslevel", "US Detail", choices=c("Country", "State", "County"), selected="State")
uiOutput("worldoverviewinputs")
```


Row
-----------------------------------------------------------------------
### World Map

```{r worldmap}
world_cases <- reactive({
  req(input$worlddate)
  #req(input$worlduslevel) 
  todisplay <- world_cases_jh() %>% 
    dplyr::filter(date == input$worlddate)
  
#  if (input$worlduslevel == "State") {
#    todisplay %<>% anti_join(
#      locations %>% filter(Location == "US")
#    ) %>% bind_rows(
#      cases_state_nyt %>% rename(dead=deaths, confirmed=cases)
#    )
#  } else if (input$worlduslevel == "County") {
#    todisplay %<>% anti_join(
#      locations %>% filter(Location == "US")
#    ) %>% bind_rows(
#      cases_county_nyt %>% rename(dead=deaths, confirmed=cases)
#    )
 # }
  
  todisplay %>% 
    inner_join(locations) %>%
    ungroup() %>% 
    select(confirmed, dead, lat, lng, Sublocation, Subsublocation, Location) %>% 
    mutate(
      popup=paste0('<font color="blue">', 
                   case_when(
                     ! is.na(Subsublocation) ~ paste0(Subsublocation, ", ", Sublocation, ", ", Location), 
                     ! is.na(Sublocation) ~ paste0(Sublocation, ", ", Location), 
                     TRUE ~ Location
                   ),
                   "</font><br/>", 
                   "Confirmed: ", confirmed, 
                   "<br/>Deaths: ", dead),
      popup=map(popup, HTML)
    ) 
})

output$worldview <- renderLeaflet({
  leaflet(
    options=leafletOptions(minZoom=2)
  ) %>% 
    addProviderTiles(providers$CartoDB.Positron)
})

sizer <- 2000

observe({
  leafletProxy("worldview", data=world_cases(), deferUntilFlush=T) %>%
    clearShapes() %>% 
    addCircles(group="Confirmed", weight=0, opacity=0, fillOpacity = 0.3, 
             color="Blue", radius = ~(sqrt(confirmed) * sizer),
             label=~popup) %>% 
    addCircles(group="Deaths", weight=0, opacity=0, fillOpacity = 0.3, 
              color="red", radius= ~(sqrt(dead) * sizer)) %>%
    addLayersControl(overlayGroups=c("Confirmed", "Deaths"))
})

leafletOutput("worldview")
```

Row {data-height=300}
----------------------------------------------------

### World Cases Flat

```{r worldcasesflat}
world_case_summary <- reactive(world_cases_jh() %>%
  ungroup() %>%
  group_by(date) %>%
  select(-loc_id) %>%
  summarize_all(sum)
)

output$worldcaseslinear <- renderHighchart(
  highchart()  %>%
    hc_title(text="Cases") %>%
    hc_yAxis(title="", type=input$worldscale) %>% 
    hc_xAxis(type="datetime") %>% 
    hc_add_series(type="line", 
                  mapping=hcaes(x=date, y=val, group=Series), 
                  data=world_case_summary() %>% 
                    select(date, Confirmed=confirmed, Deaths=dead, 
                           Recovered=recovered) %>%
                    mutate(Active = Confirmed - Deaths - Recovered) %>% 
                    gather(key="Series", value="val", -date)
                    )
)

highchartOutput("worldcaseslinear")
```

### New Cases Per Day

```{r worldnewcases}
output$dailynewcases <- renderHighchart(
  highchart()  %>%
    hc_title(text="New Cases Per Day") %>%
    hc_yAxis(title="") %>%
    hc_xAxis(type="datetime") %>% 
    hc_add_series(type="column", mapping=hcaes(x=date, y=New), 
                  data= world_case_summary() %>% 
                    select(date, New=new_confirmed),
                  name="New Cases")
)

highchartOutput("dailynewcases")
```


United States
================================================

Inputs {.sidebar}
-----------------------------------------------------------------------

### Input

```{r}
output$usinputs <- renderUI({
  cases <- dataset$cases_county_nyt()
  
  tagList(
    sliderInput("usdate", "Date:",
            min=min(cases$date), 
            max=max(cases$date), 
            value=max(cases$date), 
            timeFormat="%Y-%m-%d", 
            animate=T),
    radioButtons("uslog", "Scale", choices=list(Linear="linear", 
                                            Logarithmic="logarithmic"), 
             selected="linear")
  )
})

uiOutput("usinputs")
```

Row
-----------------------------------------------

### US Map

```{r usmap}
us_map_filter <- reactive(geometries %>% 
  filter(! is.na(county)) %>% 
  left_join(
    dataset$cases_county_nyt() %>%
      filter(cases > 0) %>% 
      inner_join(locations) %>% 
      rename(state=Sublocation, county=Subsublocation) %>% 
      mutate(
        label = paste0("<font color='blue'>", 
                       county, ", ", state, "</font><br/>", 
                       "Confirmed Cases: ",  cases, "<br/>", 
                       "Deaths: ", deaths, "<br/>"),
        label = map(label, HTML)
      )
  )
)

us_cases <- reactive({
  req(input$usdate)
  us_map_filter() %>% filter(date == input$usdate) 
})

bins <- c(1, 50, 100, 500, 1000, 5000, 7500, 10000, 15000, 25000, 50000, 75000, Inf)
pal <- colorBin("YlOrRd", domain = c(0, 100000), bins = bins)

usbox <- st_bbox(continental_us$us)
uscenter <- st_centroid(continental_us$us)

output$usview <- renderLeaflet({
  leaflet(
    options=leafletOptions(minZoom=4)
  ) %>% 
    addProviderTiles(providers$CartoDB.Positron) %>%
    addLegend(pal=pal, values=bins, opacity=0.7) %>% 
    setMaxBounds(usbox[1], usbox[2], usbox[3], usbox[4]) %>%
    setView(lat=uscenter[[1]][2], lng=uscenter[[1]][1], zoom=4)
})

observe({
  leafletProxy("usview", data=us_cases(), deferUntilFlush=T) %>%
  clearShapes()  %>%
  addPolygons(opacity = .4,
              group="Confirmed Cases", 
              weight = .3,
              fillColor = ~pal(cases),
              fillOpacity = .7,
              label = ~label, 
              highlight = highlightOptions(
                weight=5, fillOpacity=1.0, bringToFront = TRUE
                )
              ) %>%
    addLayersControl(overlayGroups=c("Confirmed Cases")) 
})

leafletOutput("usview")
```


Row 
------------------------------------------------------------------

### US Cases

```{r uscasesflat}
us_case_summary <- reactive(dataset$cases_state_nyt() %>%
  ungroup() %>%
  select(date, cases, deaths) %>% 
  group_by(date) %>%
  summarize_all(sum)
)

output$uscaseslinear <- renderHighchart({
  req(input$uslog)
  highchart() %>% 
    hc_title(text="Confirmed Cases, Hosp. and Deaths (U.S.)") %>%
    hc_yAxis(title="", type=input$uslog, min=1) %>%
    hc_xAxis(type="datetime") %>% 
    hc_add_series(
      type="line",
      data=us_case_summary() %>% 
        select(date, Confirmed=cases, Deaths=deaths) %>% 
        gather(key="Series", value="val", -date) %>% 
        bind_rows(
          dataset$covid_track() %>% 
            group_by(date) %>% 
            summarize(val = max(hospitalized, na.rm=T)) %>%
            mutate(Series="Hospitalizations")
        ), 
      mapping=hcaes(x=date, y=val, group=Series)
    )
})

highchartOutput("uscaseslinear")
```


### New Cases Per Day

```{r usewcases}
output$usdailynewcases <- renderHighchart(
  highchart() %>% 
    hc_title(text="New Cases Per Day") %>%
    hc_xAxis(type="datetime") %>%
    hc_yAxis(title="", type=input$uslog, min=1) %>% 
    hc_add_series(type="column", 
                  data=us_case_summary() %>% 
                    arrange(date) %>%
                    mutate(new_confirmed = cases - lag(cases, 1, default=0)) %>%
                    select(date, New=new_confirmed), 
                  mapping=hcaes(x=date, y=New),
                  name="New Cases")
)

highchartOutput("usdailynewcases")
```

### New Hospitalizations Per Day

```{r ushosp}
output$ushospperday <- renderHighchart({
  highchart() %>% 
    hc_title(text="New Hospitalizations Per Day (U.S.)") %>%
    hc_yAxis(title="", type=input$uslog, min=1) %>%
    hc_xAxis(type="datetime") %>% 
    hc_add_series(
      type="column",
      data=dataset$covid_track() %>% 
        group_by(date) %>% 
        summarize(Hospitalizations = max(hospitalized, na.rm=T)) %>%
        filter(Hospitalizations > 0) %>% 
        arrange(date) %>% 
        mutate(Hospitalizations = Hospitalizations - lag(Hospitalizations, default=0)), 
      mapping=hcaes(x=date, y=Hospitalizations),
      name="New Hospitalizations"
    )
})

highchartOutput("ushospperday")
```

US Testing
=====================================================

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r testinginputs}
checkboxGroupInput("testingstates", label = "States to Show", 
                   choices = state.name, 
                   selected=state.name)

covid_track_to_show <- reactive(
  dataset$covid_track() %>% 
    semi_join(
      locations %>% filter(Sublocation %in% input$testingstates,
                           is.na(Subsublocation))
    ) %>%
    select(-state, -fips, -dateChecked) %>% 
    group_by(date, loc_id) %>% 
    summarize_all(~as.numeric(max(., na.rm=T))) %>%
    mutate_all(~if_else(is.infinite(.), 0, as.numeric(.))) %>% 
    ungroup() 
)
```

Row
-----------------------------------------------------

### US Testing (Cumulative)

```{r ustesting}
output$ustesting <- renderHighchart(
  highchart()  %>%
    hc_plotOptions(column=list(stacking="normal")) %>%
    hc_title(text="Cumulative US Testing") %>%
    hc_yAxis(title="") %>%
    hc_xAxis(type="datetime") %>% 
    hc_add_series(data = covid_track_to_show() %>% 
                        select(date, positive, negative, pending) %>% 
                        group_by(date) %>% 
                        summarize_all(~sum(., na.rm=T)) %>%
                        gather(key="Series", val="val", -date), 
                  type="column", 
                  mapping=hcaes(x=date, y=val, group=Series, fill=Series))
)

highchartOutput("ustesting")
```

### US Testing (Incremental)

```{r ustestinginc}
output$ustestinginc <- renderHighchart(
  highchart()  %>%
    hc_plotOptions(column=list(stacking="normal")) %>%
    hc_title(text="Incremental US Testing") %>%
    hc_yAxis(title="") %>%
    hc_xAxis(type="datetime") %>% 
    hc_add_series(data = covid_track_to_show() %>% 
                    select(date, positive, negative) %>% 
                    group_by(date) %>% 
                    summarize_all(~sum(., na.rm=T)) %>%
                    arrange(date) %>%
                    mutate_if(is.numeric, ~ . - lag(., 1L, default=0)) %>%
                    gather(key="Series", val="val", -date), 
                  type="column", 
                  mapping=hcaes(x=date, y=val, group=Series, fill=Series))
)

highchartOutput("ustestinginc")
```

Row
---------------------------------------------------

### Tests Per Day By State

```{r testsperdaybystate}
output$ustestingbystateinc <- renderHighchart(
  highchart() %>%
    #hc_plotOptions(column=list(stacking="normal")) %>%
    hc_title(text="Daily Testing By State") %>%
    hc_xAxis(type="datetime") %>% 
    hc_yAxis(title="") %>%
    hc_add_series(
      data=covid_track_to_show() %>% 
        select(date, positiveIncrease, negativeIncrease, loc_id) %>% 
        mutate(tests = positiveIncrease + negativeIncrease) %>%
        select(-positiveIncrease, -negativeIncrease) %>% 
        inner_join(locations %>% select(loc_id, state=Sublocation)) %>% 
        select(-loc_id),
      mapping=hcaes(x=date, y=tests, group=state),
      type="line"
    )
)

highchartOutput("ustestingbystateinc")
```

New York City Testing
===================================================

## New York City

```{r usmap}
nyzip_geoms <- reactive(
  zips %>% 
    inner_join(dataset$nyzipcode() %>% mutate(zipcode=as.character(zipcode))) %>% 
    mutate(
      lat = map(geometry, ~ .[[1]][1]), 
      lng=map(geometry, ~.[[2]][1]), 
      lat=unlist(lat), 
      lng=unlist(lng), 
      rate = Positive / Total
    )
)

leaflet(data=together) %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircles(group="Positive", weight=0, opacity=0, fillOpacity = 0.3, 
             color="Blue", radius = ~(sqrt(Positive) * 30))

output$nyview <- renderLeaflet({
  leaflet(
    options=leafletOptions(minZoom=4)
  ) %>% 
    addProviderTiles(providers$CartoDB.Positron) %>%
    addLegend(pal=pal, values=bins, opacity=0.7) %>% 
    setMaxBounds(usbox[1], usbox[2], usbox[3], usbox[4]) %>%
    setView(lat=uscenter[[1]][2], lng=uscenter[[1]][1], zoom=4)
})

observe({
  leafletProxy("usview", data=us_cases(), deferUntilFlush=T) %>%
  clearShapes()  %>%
  addPolygons(opacity = .4,
              group="Confirmed Cases", 
              weight = .3,
              fillColor = ~pal(cases),
              fillOpacity = .7,
              label = ~label, 
              highlight = highlightOptions(
                weight=5, fillOpacity=1.0, bringToFront = TRUE
                )
              ) %>%
    addLayersControl(overlayGroups=c("Confirmed Cases")) 
})

leafletOutput("usview")
```


Interventions
====================================================

```{r munge_intervention_data}
locs_with_intervention <- reactive(
  dataset$interventions() %>% group_by(loc_id) %>% summarize()
)

counties_with_intervention <- reactive(dataset$cases_county_nyt() %>% semi_join(locs_with_intervention())
)

interventions_with_cases <- reactive(dataset$interventions() %>% 
  inner_join(dataset$cases_county_nyt()) %>% 
  inner_join(locations) %>%
  rename(county=Subsublocation, state=Sublocation) %>%
  mutate(name = paste0(county, ", ", state)) %>%
  select(name, cases, intervention, date)
)

```

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r interventioninputs}
output$interventioninputs <- renderUI({
  avail_states <- dataset$interventions() %>%
    inner_join(locations) %>%
    use_series(Sublocation) %>% unique() %>% sort()
  
  tagList(
      checkboxGroupInput("interventionstates", label = "States to Show", 
                   choices = avail_states, 
                   selected=c("New York", "California")),
      radioButtons("interventionlog", label="Log or Linear", choices=c("logarithmic", "linear"), selected="logarithmic"),
      sliderInput("interventionstartcases", label="Start # of Cases", 
              min=1, max=1000, value=10)
  )
})

uiOutput("interventioninputs")
```

Row 
---------------------------------------------------------------------- 

```{r interventions}
relative_dates <- reactive(
  counties_with_intervention() %>% 
    semi_join(
      locations %>% 
        filter(Sublocation %in% input$interventionstates)
      ) %>% 
    group_by(loc_id) %>%
    arrange(date) %>% 
    filter(cases >= input$interventionstartcases) %>%
    filter(row_number() == 1) %>%
    select(loc_id, first_date=date)
)

counties_to_show <- reactive(counties_with_intervention() %>% 
    inner_join(relative_dates()) %>%
    filter(date >= first_date) %>%
    mutate(days = as.numeric(date - first_date)) %>%   
    inner_join(locations) %>% 
    rename(county=Subsublocation, state=Sublocation) %>%
    mutate(name = paste0(county, ", ", state)) %>%
    left_join(dataset$interventions()) 
)

interventions_with_cases <- reactive(counties_to_show() %>% filter(! is.na(intervention)))

output$interventions <- renderHighchart(
  highchart() %>% 
    hc_add_series(data=counties_to_show(), type="line", 
                     mapping=hcaes(x=days, y=cases, group=name), 
                     colorAxis=0,
                     lineWidth=1, 
                  marker=list(enabled=FALSE),
                  tooltip=list(
                    pointFormat="Date: {point.date}<br/>Cases: {point.cases}"
                  )) %>% 
    hc_yAxis(title="Cases", type=input$interventionlog, min=1) %>%
    hc_add_series(data=interventions_with_cases(), type="point", 
                  mapping=hcaes(x=days, y=cases, fill=name,
                                color=name, group=intervention), 
                  colorAxis=0, tooltip=list(
                    headerFormat="<span style='color:{point.color}'>●</span> <span style='font-size: 12px'> {series.name}</span><br/>",
                    pointFormat="{point.name}<br/>Date: {point.date}<br/>Cases: {point.cases}"
                  ))
)

highchartOutput("interventions")
```
